{% extends "base.html" %}

{% block title %}{% if guild %}{{ guild.name }} - Analytics{% else %}Guild Analytics{% endif %}{% endblock %}

{% block content %}
<div class="min-h-screen py-8">
    <div class="max-w-6xl mx-auto px-4">
        
        {% if error %}
        <!-- Error State -->
        <div class="bg-gw2-dark/80 backdrop-blur rounded-2xl border border-red-500/30 p-8 text-center mb-6">
            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
            <h2 class="text-2xl font-display font-bold text-red-400 mb-4">
                {% if lang == 'en' %}Error{% else %}Erreur{% endif %}
            </h2>
            <p class="text-gray-400 mb-6">{{ error }}</p>
            <a href="/api/gw2/dashboard" class="inline-block px-6 py-3 bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-bold rounded-lg hover:from-cyan-600 hover:to-blue-700 transition-all">
                {% if lang == 'en' %}Back to Dashboard{% else %}Retour au Dashboard{% endif %}
            </a>
        </div>
        {% endif %}
        
        {% if guild %}
        <!-- Header -->
        <div class="bg-gw2-dark/80 backdrop-blur rounded-2xl border border-cyan-500/30 p-6 mb-6">
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-xl">
                    [{{ guild.tag }}]
                </div>
                <div>
                    <h1 class="text-3xl font-display font-bold text-white">{{ guild.name }}</h1>
                    <p class="text-gray-400">[{{ guild.tag }}] - {% if lang == 'en' %}Guild Analytics{% else %}Analytics de Guilde{% endif %}</p>
                </div>
            </div>
        </div>

        {% if stats %}
        <!-- Stats Overview -->
        <div class="grid md:grid-cols-4 gap-4 mb-6">
            <div class="bg-gw2-dark/80 backdrop-blur rounded-xl border border-cyan-500/20 p-4 text-center">
                <div class="text-3xl font-bold text-cyan-400">{{ stats.total_fights }}</div>
                <div class="text-sm text-gray-400">{% if lang == 'en' %}Total Fights{% else %}Combats Totaux{% endif %}</div>
            </div>
            <div class="bg-gw2-dark/80 backdrop-blur rounded-xl border border-green-500/20 p-4 text-center">
                <div class="text-3xl font-bold text-green-400">{{ stats.win_rate|round(1) }}%</div>
                <div class="text-sm text-gray-400">{% if lang == 'en' %}Win Rate{% else %}Taux de Victoire{% endif %}</div>
            </div>
            <div class="bg-gw2-dark/80 backdrop-blur rounded-xl border border-purple-500/20 p-4 text-center">
                <div class="text-3xl font-bold text-purple-400">{{ stats.member_count }}</div>
                <div class="text-sm text-gray-400">{% if lang == 'en' %}Members Tracked{% else %}Membres Suivis{% endif %}</div>
            </div>
            <div class="bg-gw2-dark/80 backdrop-blur rounded-xl border border-amber-500/20 p-4 text-center">
                <div class="text-3xl font-bold text-amber-400">{{ stats.active_members }}</div>
                <div class="text-sm text-gray-400">{% if lang == 'en' %}Active (30d){% else %}Actifs (30j){% endif %}</div>
            </div>
        </div>

        {% set total_participations = stats.role_distribution.values()|list|sum %}
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <!-- Role Distribution -->
            <div class="bg-gw2-dark/80 backdrop-blur rounded-2xl border border-purple-500/20 p-6">
                <h3 class="text-xl font-display font-bold text-purple-400 mb-4">
                    {% if lang == 'en' %}Role Distribution{% else %}R√©partition des R√¥les{% endif %}
                    <span class="text-sm font-normal text-gray-500 ml-2">({{ total_participations }} {% if lang == 'en' %}participations{% else %}participations{% endif %})</span>
                </h3>
                <div class="space-y-3">
                    {% for role, count in stats.role_distribution.items() %}
                    {% set pct = (count / total_participations * 100)|round(1) if total_participations > 0 else 0 %}
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-300 capitalize">{{ role|replace('_', ' ') }}</span>
                            <span class="text-gray-400">{{ pct }}%</span>
                        </div>
                        <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full rounded-full
                                {% if role == 'dps' %}bg-red-500
                                {% elif role == 'stab' %}bg-yellow-500
                                {% elif role == 'healer' %}bg-cyan-500
                                {% elif role == 'boon' %}bg-green-500
                                {% elif role == 'dps_strip' %}bg-orange-500
                                {% else %}bg-purple-500{% endif %}"
                                style="width: {{ pct }}%"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Spec Distribution -->
            {% set total_spec_participations = stats.spec_distribution|map('last')|list|sum if stats.spec_distribution else 0 %}
            <div class="bg-gw2-dark/80 backdrop-blur rounded-2xl border border-amber-500/20 p-6">
                <h3 class="text-xl font-display font-bold text-amber-400 mb-4">
                    {% if lang == 'en' %}Top Specializations{% else %}Top Sp√©cialisations{% endif %}
                </h3>
                <div class="space-y-2">
                    {% set max_spec_count = stats.spec_distribution[0][1] if stats.spec_distribution else 1 %}
                    {% for spec, count in stats.spec_distribution[:8] %}
                    {% set pct = (count / max_spec_count * 100)|round(1) if max_spec_count > 0 else 0 %}
                    {% set profession = spec_to_profession.get(spec, 'Warrior') %}
                    <div class="flex items-center gap-3">
                        <img src="/static/icons/{{ spec|lower }}.png" 
                             alt="{{ spec }}" class="w-6 h-6"
                             onerror="this.src='/static/icons/{{ profession|lower }}.png'">
                        <div class="flex-1">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-300">{{ spec }}</span>
                                <span class="text-gray-400">{{ count }} {% if lang == 'en' %}plays{% else %}jou√©es{% endif %}</span>
                            </div>
                            <div class="h-1.5 bg-gray-700 rounded-full overflow-hidden mt-1">
                                <div class="h-full bg-amber-500 rounded-full" style="width: {{ pct }}%"></div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Top Performers -->
        <div class="bg-gw2-dark/80 backdrop-blur rounded-2xl border border-green-500/20 p-6 mb-6">
            <h3 class="text-xl font-display font-bold text-green-400 mb-4">
                {% if lang == 'en' %}Top Participants{% else %}Top Participants{% endif %}
            </h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-left border-b border-gray-700">
                            <th class="py-2 px-3 text-gray-400">#</th>
                            <th class="py-2 px-3 text-gray-400">{% if lang == 'en' %}Player{% else %}Joueur{% endif %}</th>
                            <th class="py-2 px-3 text-gray-400 text-right">{% if lang == 'en' %}Fights{% else %}Combats{% endif %}</th>
                            <th class="py-2 px-3 text-gray-400 text-right">{% if lang == 'en' %}Participation{% else %}Participation{% endif %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for player in stats.top_performers[:10] %}
                        <tr class="border-b border-gray-800 hover:bg-gray-800/30">
                            <td class="py-2 px-3 text-gray-500">{{ loop.index }}</td>
                            <td class="py-2 px-3 text-white font-medium">{{ player.account_name }}</td>
                            <td class="py-2 px-3 text-right text-cyan-400">{{ player.fights }}</td>
                            <td class="py-2 px-3 text-right">
                                {% set pct = (player.fights / stats.total_fights * 100)|round(1) if stats.total_fights > 0 else 0 %}
                                <span class="text-green-400">{{ pct }}%</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Best Group Compositions -->
        {% if group_comparison and group_comparison.best_groups %}
        <div class="bg-gw2-dark/80 backdrop-blur rounded-2xl border border-yellow-500/20 p-6 mb-6">
            <h3 class="text-xl font-display font-bold text-yellow-400 mb-4">
                üèÜ {% if lang == 'en' %}Best Group Compositions{% else %}Meilleures Compositions de Groupe{% endif %}
            </h3>
            <p class="text-sm text-gray-400 mb-4">
                {% if lang == 'en' %}Optimal 5-player groups based on performance metrics and role balance ({{ group_comparison.total_players }} players analyzed){% else %}Groupes optimaux de 5 joueurs bas√©s sur les m√©triques de performance et l'√©quilibre des r√¥les ({{ group_comparison.total_players }} joueurs analys√©s){% endif %}
            </p>
            
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for group in group_comparison.best_groups %}
                <div class="bg-gw2-darker/50 rounded-xl p-4 border border-yellow-500/20 hover:border-yellow-500/40 transition-colors">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-lg font-bold text-yellow-400">
                            {% if loop.index == 1 %}ü•á{% elif loop.index == 2 %}ü•à{% elif loop.index == 3 %}ü•â{% else %}#{{ loop.index }}{% endif %}
                            {% if lang == 'en' %}Group{% else %}Groupe{% endif %} {{ loop.index }}
                        </span>
                        <span class="px-2 py-1 rounded bg-yellow-500/20 text-yellow-400 text-sm font-bold">
                            {{ group.combined_score }}%
                        </span>
                    </div>
                    
                    <div class="space-y-2 mb-3">
                        {% for i in range(group.players|length) %}
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-300">{{ group.players[i] }}</span>
                            <span class="px-2 py-0.5 rounded text-xs
                                {% if group.roles[i] == 'healer' %}bg-green-500/20 text-green-400
                                {% elif group.roles[i] == 'stab' %}bg-yellow-500/20 text-yellow-400
                                {% elif group.roles[i] == 'dps_strip' %}bg-purple-500/20 text-purple-400
                                {% else %}bg-orange-500/20 text-orange-400{% endif %}">
                                {{ group.roles[i]|replace('_', ' ')|title }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="flex justify-between text-xs text-gray-500 border-t border-gray-700 pt-2">
                        <span>{% if lang == 'en' %}Perf{% else %}Perf{% endif %}: {{ group.performance_score }}%</span>
                        <span>{% if lang == 'en' %}Balance{% else %}√âquilibre{% endif %}: {{ group.role_balance_score }}%</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Monthly Activity Chart -->
        <div class="bg-gw2-dark/80 backdrop-blur rounded-2xl border border-blue-500/20 p-6">
            <h3 class="text-xl font-display font-bold text-blue-400 mb-4">
                {% if lang == 'en' %}Monthly Activity{% else %}Activit√© Mensuelle{% endif %}
                <span class="text-sm font-normal text-gray-500 ml-2">({% if lang == 'en' %}fights per month{% else %}combats par mois{% endif %})</span>
            </h3>
            {% set sorted_months = stats.monthly_activity|dictsort %}
            {% set max_monthly = stats.monthly_activity.values()|max if stats.monthly_activity else 1 %}
            
            {# Get current year and create all 12 months #}
            {% set current_year = '2025' %}
            {% if stats.monthly_activity %}
                {% set last_month_key = stats.monthly_activity.keys()|list|last %}
                {% if last_month_key %}
                    {% set current_year = last_month_key[:4] %}
                {% endif %}
            {% endif %}
            {% set all_months = [] %}
            {% for i in range(12) %}
                {% set month_num = i + 1 %}
                {% set month_str = '%02d' % month_num %}
                {% set month_key = current_year + '-' + month_str %}
                {% set month_count = stats.monthly_activity.get(month_key, 0) %}
                {% set _ = all_months.append((month_key, month_count)) %}
            {% endfor %}
            
            {% set max_monthly = max_monthly if max_monthly > 0 else 1 %}
            <div class="relative">
                <!-- Y-axis labels -->
                <div class="absolute left-0 top-0 h-48 flex flex-col justify-between text-xs text-gray-500 pr-2">
                    <span>{{ max_monthly }}</span>
                    <span>{{ (max_monthly / 2)|int }}</span>
                    <span>0</span>
                </div>
                <!-- Chart -->
                <div class="ml-10 h-48 flex items-end gap-1 border-l border-b border-gray-700">
                    {% for month, count in all_months %}
                    {% set height = (count / max_monthly * 100)|round if max_monthly > 0 else 0 %}
                    <div class="flex-1 flex flex-col items-center" style="min-width: 30px;">
                        <span class="text-xs text-cyan-400 mb-1">{{ count }}</span>
                        <div class="w-full {% if count > 0 %}bg-gradient-to-t from-blue-600 to-cyan-400 hover:from-blue-500 hover:to-cyan-300{% else %}bg-gray-700{% endif %} rounded-t transition-all cursor-pointer" 
                             style="height: {{ height }}%" title="{{ month }}: {{ count }} combats"></div>
                    </div>
                    {% endfor %}
                </div>
                <!-- X-axis labels -->
                <div class="ml-10 flex gap-1 mt-2">
                    {% set month_names = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sep', 'Oct', 'Nov', 'D√©c'] %}
                    {% for i in range(12) %}
                    <div class="flex-1 text-center" style="min-width: 30px;">
                        <span class="text-xs text-gray-500">{{ month_names[i] }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        {% else %}
        <!-- No Data - Import Section -->
        <div class="bg-gw2-dark/80 backdrop-blur rounded-2xl border border-blue-500/20 p-12 text-center">
            <div class="text-6xl mb-4">üìä</div>
            <h3 class="text-xl font-bold text-gray-300 mb-2">
                {% if lang == 'en' %}No Data Yet{% else %}Pas encore de donn√©es{% endif %}
            </h3>
            <p class="text-gray-500 mb-6">
                {% if lang == 'en' %}
                    Import your existing fight history from analyzed logs to start tracking guild statistics.
                {% else %}
                    Importez votre historique de combats depuis les logs d√©j√† analys√©s pour suivre les statistiques de guilde.
                {% endif %}
            </p>
            <button onclick="importGuildFights()" id="import-btn"
                    class="px-6 py-3 bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-bold rounded-lg hover:from-cyan-600 hover:to-blue-700 transition-all disabled:opacity-50">
                <span id="import-btn-text">{% if lang == 'en' %}Import Fight History{% else %}Importer l'Historique{% endif %}</span>
                <span id="import-btn-loading" class="hidden">
                    <svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </span>
            </button>
            <div id="import-result" class="mt-4 hidden"></div>
        </div>
        {% endif %}

        <!-- Back Link -->
        <div class="mt-6 text-center">
            <a href="/api/gw2/dashboard" class="text-cyan-400 hover:text-cyan-300 transition-colors">
                ‚Üê {% if lang == 'en' %}Back to Dashboard{% else %}Retour au Dashboard{% endif %}
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script>
{% if guild %}
async function importGuildFights() {
    const btn = document.getElementById('import-btn');
    const btnText = document.getElementById('import-btn-text');
    const btnLoading = document.getElementById('import-btn-loading');
    const resultDiv = document.getElementById('import-result');
    
    if (!btn) return;
    
    btn.disabled = true;
    btnText.classList.add('hidden');
    btnLoading.classList.remove('hidden');
    resultDiv.classList.add('hidden');
    
    try {
        const response = await fetch('/api/gw2/guild/{{ guild.id }}/import', { method: 'POST' });
        const data = await response.json();
        
        resultDiv.classList.remove('hidden');
        
        if (data.success) {
            if (data.imported > 0) {
                resultDiv.innerHTML = `
                    <div class="bg-green-500/20 border border-green-500/30 rounded-lg p-4 text-green-400">
                        <div class="text-2xl mb-2">‚úÖ</div>
                        <p class="font-bold">${data.imported} {% if lang == 'en' %}fights imported!{% else %}combats import√©s !{% endif %}</p>
                        <p class="text-sm text-gray-400 mt-1">${data.skipped} {% if lang == 'en' %}duplicates skipped{% else %}doublons ignor√©s{% endif %}</p>
                        <button onclick="location.reload()" class="mt-3 px-4 py-2 bg-green-500/30 rounded-lg hover:bg-green-500/40 transition-colors">
                            {% if lang == 'en' %}Refresh Page{% else %}Rafra√Æchir{% endif %}
                        </button>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="bg-amber-500/20 border border-amber-500/30 rounded-lg p-4 text-amber-400">
                        <div class="text-2xl mb-2">‚ÑπÔ∏è</div>
                        <p>{% if lang == 'en' %}No new fights found{% else %}Aucun nouveau combat trouv√©{% endif %}</p>
                        <p class="text-sm text-gray-400 mt-1">${data.total_in_db} {% if lang == 'en' %}logs analyzed{% else %}logs analys√©s{% endif %}, ${data.skipped} {% if lang == 'en' %}already imported{% else %}d√©j√† import√©s{% endif %}</p>
                    </div>
                `;
            }
        } else {
            resultDiv.innerHTML = `
                <div class="bg-red-500/20 border border-red-500/30 rounded-lg p-4 text-red-400">
                    <p>{% if lang == 'en' %}Error{% else %}Erreur{% endif %}: ${data.error}</p>
                </div>
            `;
        }
    } catch (error) {
        resultDiv.classList.remove('hidden');
        resultDiv.innerHTML = `
            <div class="bg-red-500/20 border border-red-500/30 rounded-lg p-4 text-red-400">
                <p>{% if lang == 'en' %}Network error{% else %}Erreur r√©seau{% endif %}: ${error.message}</p>
            </div>
        `;
    } finally {
        btn.disabled = false;
        btnText.classList.remove('hidden');
        btnLoading.classList.add('hidden');
    }
}
{% endif %}
</script>
{% endblock %}
